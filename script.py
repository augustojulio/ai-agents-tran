import os
import requests
from crewai import Agent, Task, Crew
from dotenv import load_dotenv

# Carregar vari√°veis de ambiente
load_dotenv()
ACCESS_TOKEN = os.getenv("ACCESS_TOKEN")

# Fun√ß√£o para pegar estat√≠sticas do Instagram
def test_facebook_api():
    url = f"https://graph.facebook.com/v22.0/me"
    params = {
        "access_token": ACCESS_TOKEN
    }
    response = requests.get(url, params=params)
    return response.json()

# Fun√ß√£o para pegar dados da API de Marketing do Facebook
def get_facebook_ads_insights():
    AD_ACCOUNT_ID = os.getenv("AD_ACCOUNT_ID")
    url = f"https://graph.facebook.com/v22.0/act_{AD_ACCOUNT_ID}/insights"
    params = {
        "fields": "campaign_name,impressions,reach,clicks,spend",
        "level": "campaign",
        "time_range": '{"since":"2024-01-01","until":"2025-02-01"}',  
        "access_token": ACCESS_TOKEN
    }

    response = requests.get(url, params=params)
    return response.json()

# Definir agentes
coletor = Agent(
    name="Coletor de Dados",
    role="Extrai m√©tricas de tr√°fego do Facebook e Instagram",
    backstory="Especialista em an√°lise de tr√°fego digital no Facebook e Instagram.",
    goal="Obter m√©tricas detalhadas das redes sociais para an√°lise."
)

analista = Agent(
    name="Analista de Tr√°fego",
    role="Analisa padr√µes de tr√°fego e comportamento dos usu√°rios",
    backstory="Especialista em marketing digital, detecta tend√™ncias e padr√µes.",
    goal = "Analisar dados de tr√°fego para identificar oportunidades."
)

gerador_relatorio = Agent(
    name="Gerador de Relat√≥rios",
    role="Cria resumos e insights a partir dos dados analisados",
    backstory="Especialista em comunica√ß√£o e estrat√©gia digital, gera relat√≥rios prontos para a√ß√£o.",
    goal = "Sintetizar dados e insights em um relat√≥rio executivo."
)

# Definir tarefas
tarefa_coletar = Task(
    description="Obter m√©tricas de tr√°fego do Facebook e Instagram usando APIs.",
    agent=coletor,
    expected_output = "Dados coletados com sucesso."
)

tarefa_analisar = Task(
    description="Analisar padr√µes de tr√°fego com base nos dados coletados.",
    agent=analista,
    expected_output = "An√°lise de tr√°fego conclu√≠da."
)

tarefa_gerar_relatorio = Task(
    description="Gerar um relat√≥rio com insights e recomenda√ß√µes.",
    agent=gerador_relatorio,
    expected_output = "Relat√≥rio gerado com sucesso."
)

# Criar equipe de agentes
crew = Crew(
    agents=[coletor, analista, gerador_relatorio],
    tasks=[tarefa_coletar, tarefa_analisar, tarefa_gerar_relatorio]
)

if __name__ == "__main__":
    # Coletar dados
    data = test_facebook_api()
    ads_data = get_facebook_ads_insights()
    
    # print(f"test_facebook_api: {data}")
    # print(f"ads_data: {ads_data}")
    
    # Verifica se ads_data tem dados v√°lidos
    dados_para_analise = ads_data.get("data", [])
    
    if not dados_para_analise:  
        print("‚ö†Ô∏è Nenhum dado de an√∫ncios encontrado. Usando dados do Facebook API para relat√≥rio.")
        dados_para_analise = data  # Usa os dados do Facebook em vez de Ads
    
    # Passa os dados para an√°lise da CrewAI
    crew.kickoff(inputs={"dados": dados_para_analise})
    
    # Criar relat√≥rio
    report = f"""
    üìä Relat√≥rio de Tr√°fego:
    {dados_para_analise}

    üì¢ Insights:
    - Impress√µes: {dados_para_analise[0]['impressions'] if isinstance(dados_para_analise, list) and dados_para_analise else "N/A"}
    - Alcance: {dados_para_analise[0]['reach'] if isinstance(dados_para_analise, list) and dados_para_analise else "N/A"}
    - Cliques: {dados_para_analise[0]['clicks'] if isinstance(dados_para_analise, list) and dados_para_analise else "N/A"}
    - Investimento: {dados_para_analise[0]['spend'] if isinstance(dados_para_analise, list) and dados_para_analise else "N/A"}
    """

    print(report)
